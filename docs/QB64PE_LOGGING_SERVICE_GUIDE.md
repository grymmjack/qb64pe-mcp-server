# QB64PE Native Logging Service Documentation

## Overview

The QB64PE Logging Service provides comprehensive native logging capabilities specifically designed for LLM-automated debugging workflows. This service implements the critical discovery that `$CONSOLE:ONLY` enables proper shell redirection, making QB64PE programs compatible with automated output capture and analysis.

## Key Discovery: $CONSOLE:ONLY vs $CONSOLE

### The Critical Difference

```basic
' ❌ WRONG - Creates separate console window
$CONSOLE

' ✅ CORRECT - Enables shell output redirection  
$CONSOLE:ONLY
```

### Impact on Automation

- **`$CONSOLE`**: Creates a separate console window that cannot be redirected
- **`$CONSOLE:ONLY`**: Enables shell redirection: `program.exe > output.txt 2>&1`
- **Result**: LLMs can now capture and analyze QB64PE program output automatically

## Native QB64PE Logging Functions

QB64PE includes built-in logging functions that this service leverages:

```basic
_LOGINFO "Information level message"
_LOGERROR "Error level with stacktrace" 
_LOGWARN "Warning level message"
_LOGTRACE "Trace level message"
value = _LOGMINLEVEL() ' Get current logging level
```

## Service Features

### 1. Native Logging Injection

**Tool**: `inject_native_qb64pe_logging`

- Automatically injects native QB64PE logging functions
- Ensures `$CONSOLE:ONLY` directive for shell redirection
- Adds structured output sections for systematic debugging
- Includes auto-exit mechanism for automation compatibility

#### Example Input:
```basic
PRINT "Hello World"
FOR i = 1 TO 10
    PRINT i
NEXT i
```

#### Example Output:
```basic
$CONSOLE:ONLY
OPTION _EXPLICIT

' Native QB64PE Logging Functions
' Logging Level: INFO
' Auto-generated by QB64PE Logging Service

PRINT "=== PROGRAM ANALYSIS ==="
_LOGINFO "Starting program analysis"
PRINT "Hello World"

PRINT "=== STEP 1: HEADER VALIDATION ==="
_LOGINFO "Starting header validation"
FOR i = 1 TO 10
    PRINT i
NEXT i

PRINT "=== RESULTS SUMMARY ==="
_LOGINFO "Analysis completed successfully"

' Auto-exit mechanism for automation
IF DEBUG_MODE = 1 THEN
    PRINT "Auto-exiting in 10 seconds..."
    _DELAY 10
    SYSTEM
END IF
```

### 2. Advanced Debugging Templates

**Tool**: `generate_advanced_debugging_template`

Creates comprehensive debugging templates with:
- Native logging integration
- Structured output sections
- Error handling and cleanup
- Execution timing
- Resource management

#### Usage Example:
```typescript
{
  "programName": "ZLIB Analysis",
  "analysisSteps": [
    "Header Validation",
    "DEFLATE Parsing", 
    "CRC32 Verification",
    "Data Extraction"
  ]
}
```

### 3. Structured Output Parsing

**Tool**: `parse_qb64pe_structured_output`

Automatically parses structured output from enhanced QB64PE programs:

```json
{
  "analysis": "QB64PE Structured Output Analysis",
  "summary": {
    "executionStatus": "SUCCESS",
    "totalSteps": 4,
    "failedSteps": 0,
    "completionRate": "100%"
  },
  "sections": {
    "PROGRAM ANALYSIS": ["Program: ZLIB Analysis", "Start Time: 123456"],
    "STEP 1: HEADER VALIDATION": ["INFO: Header validation completed"],
    "RESULTS SUMMARY": ["SUCCESS: All 4 steps completed"]
  },
  "logs": [
    {
      "level": "INFO",
      "message": "Starting ZLIB analysis",
      "section": "PROGRAM ANALYSIS"
    }
  ]
}
```

### 4. Output Capture Commands

**Tool**: `generate_output_capture_commands`

Generates cross-platform commands for capturing QB64PE output:

```bash
# Windows (PowerShell)
powershell -Command "Get-Content -Path 'analysis_output.txt' -Wait -Tail 10"

# Linux/macOS  
tail -f "analysis_output.txt"

# Batch (Continuous monitoring)
powershell -Command "while($true) { Clear-Host; Get-Content 'analysis_output.txt' | Select-Object -Last 20; Start-Sleep 2 }"
```

## Proven Debugging Workflow

### 1. **Code Enhancement**
```bash
# Use MCP tool to enhance code with logging
inject_native_qb64pe_logging "your_code_here"
```

### 2. **Compilation and Execution**
```bash
# Compile enhanced program
qb64pe -c enhanced_program.bas

# Execute with output capture
enhanced_program.exe > analysis_output.txt 2>&1
```

### 3. **Output Analysis**
```bash
# Parse structured output with MCP tool
parse_qb64pe_structured_output "$(cat analysis_output.txt)"
```

## Real-World Success Case

This logging service successfully diagnosed the **ASEPRITE ZLIB issue**:

- ✅ **Identified root cause**: Incomplete Dynamic Huffman decoder
- ✅ **Quantified failure**: 51 bytes vs 82,944 expected (0.06%)
- ✅ **Validated approach**: ZLIB header correct, DEFLATE parsing fails
- ✅ **Automated workflow**: No manual intervention needed

### Output Example:
```
=== PROGRAM ANALYSIS ===
Program: ASEPRITE ZLIB Analyzer
Expected: 82944 bytes

=== STEP 1: HEADER VALIDATION ===
INFO: ZLIB header validation completed
CMF: 120, FLG: 156 - Valid header

=== STEP 2: DEFLATE PARSING ===
ERROR: Dynamic Huffman decoder incomplete
Only 51 bytes decoded (0.06% of expected)

=== RESULTS SUMMARY ===
FAILED: Incomplete DEFLATE implementation
Auto-exiting in 10 seconds...
```

## Configuration Options

### LoggingConfiguration Interface
```typescript
interface LoggingConfiguration {
    enableNativeLogging: boolean;        // Default: true
    enableStructuredOutput: boolean;     // Default: true
    consoleDirective: '$CONSOLE:ONLY';   // Default: '$CONSOLE:ONLY'
    logLevel: 'TRACE' | 'INFO' | 'WARN' | 'ERROR'; // Default: 'INFO'
    autoExitTimeout: number;             // Default: 10 seconds
    outputSections: string[];            // Custom section names
}
```

## Benefits for LLM Automation

✅ **Shell Redirection Compatible** - Works with automated pipelines  
✅ **Structured Output** - Easy parsing for LLM analysis  
✅ **Native Logging** - Uses QB64PE's built-in functions  
✅ **Auto-Exit** - Prevents hanging in automated workflows  
✅ **Cross-Platform** - Works on Windows, Linux, macOS  
✅ **Error Handling** - Comprehensive error detection and logging  
✅ **Real-Time Monitoring** - Progress tracking capabilities

## Integration with MCP Server

The logging service is fully integrated with the QB64PE MCP Server and provides these tools:

1. **inject_native_qb64pe_logging** - Add logging to existing code
2. **generate_advanced_debugging_template** - Create debug templates
3. **parse_qb64pe_structured_output** - Analyze program output
4. **generate_output_capture_commands** - Generate monitoring commands

## Best Practices

### For Code Enhancement:
- Always use `$CONSOLE:ONLY` for automated workflows
- Include structured output sections for systematic debugging
- Add auto-exit mechanisms with reasonable timeouts
- Use native logging functions for standardized output

### For LLM Integration:
- Parse structured sections systematically
- Monitor execution progress in real-time
- Capture both stdout and stderr (`2>&1`)
- Set reasonable timeouts to prevent infinite waits

### For Debugging Workflows:
- Start with enhanced templates for complex analysis
- Use structured output parsing for automated analysis
- Combine with shell monitoring for real-time feedback
- Leverage native logging for detailed error tracking

This logging service transforms QB64PE from a manual debugging environment into a fully automated, LLM-compatible debugging platform.
